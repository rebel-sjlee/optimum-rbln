name: Optimum-rbln / PR / Pytest

on:
  workflow_call:
    inputs:
      ref:
        description: "ref to checkout"
        required: false
        type: string
      pr_number:
        description: "PR number to run"
        required: false
        type: string
      rebel_compiler_version:
        description: "rebel_compiler version to run"
        required: true
        type: string
      test_level:
        description: "Test level for OPTIMUM_RBLN_TEST_LEVEL (default, full, essential)"
        required: false
        type: string
        default: "default"
      enable_hf_hub_tests:
        description: "Whether to enable HF Hub tests (requires HF credentials)"
        required: false
        type: boolean
        default: false
      fail_fast:
        description: "Whether to fail fast when one matrix job fails"
        required: false
        type: boolean
        default: true
      save_artifacts_path:
        description: "Path to save artifacts (default: empty string, which means not to save artifacts)"
        required: false
        type: string
        default: ""
      reuse_artifacts_path:
        description: "Path to reuse artifacts (default: empty string, which means not to reuse artifacts)"
        required: false
        type: string
        default: ""

env:
  HF_HOME: ${{ secrets.HF_HOME }}
  HF_USER_ID: ${{ inputs.enable_hf_hub_tests && secrets.MODEL_HUB_ID || '' }}
  HF_AUTH_TOKEN: ${{ inputs.enable_hf_hub_tests && secrets.MODEL_HUB_ACCESS || '' }}

jobs:
  pytest:
    name: Pytest (${{ matrix.test_type }})
    runs-on: ${{ (inputs.reuse_artifacts_path != '' && matrix.test_type == 'llm') && 'rbln-sw-k8s-4c-128gb' || (inputs.reuse_artifacts_path != '' && 'rbln-sw-k8s-4c-32gb' || 'rbln-sw-k8s-ca22-1') }}
    container:
      image: ${{ vars.DEV_CONTAINER_IMAGE }}
    strategy:
      fail-fast: ${{ inputs.fail_fast }}
      matrix: ${{ fromJson(
        (inputs.reuse_artifacts_path != '' || inputs.save_artifacts_path != '') &&
        '{"test_type":["transformers","diffusers","llm"]}' ||
        '{"include":[{"test_type":"config"},{"test_type":"transformers"},{"test_type":"diffusers"},{"test_type":"llm","splits":4,"group":1},{"test_type":"llm","splits":4,"group":2},{"test_type":"llm","splits":4,"group":3},{"test_type":"llm","splits":4,"group":4},{"test_type":"cli-basic"},{"test_type":"cli-argument-parsing"},{"test_type":"cli-error-handling"}]}'
        )}}
    steps:
      - name: Checkout the optimum-rbln repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_number && format('refs/pull/{0}/merge', inputs.pr_number) || inputs.ref }}
          submodules: recursive
          fetch-depth: 0

      - name: Get commit message if not provided
        id: get_commit_message
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check if test should be skipped
        id: should_skip
        env:
          COMMIT_MESSAGE: ${{ steps.get_commit_message.outputs.message }}
        run: |
          SKIP=false
          case "${{ matrix.test_type }}" in
            "transformers")
              if [[ "$COMMIT_MESSAGE" == *"[skip-transformers]"* ]]; then
                SKIP=true
              fi
              ;;
            "diffusers")
              if [[ "$COMMIT_MESSAGE" == *"[skip-diffusers]"* ]]; then
                SKIP=true
              fi
              ;;
            "llm")
              if [[ "$COMMIT_MESSAGE" == *"[skip-llms]"* ]]; then
                SKIP=true
              fi
              ;;
            cli-*)
              if [[ "$COMMIT_MESSAGE" == *"[skip-cli]"* ]]; then
                SKIP=true
              fi
              # Skip advanced CLI tests if test_level is default
              if [[ "${{ inputs.test_level }}" == "default" && "${{ matrix.test_type }}" != "cli-basic" ]]; then
                SKIP=true
              fi
              # Skip if BC test is running
              if [[ "${{ inputs.reuse_artifacts_path }}" != "" || "${{ inputs.save_artifacts_path }}" != "" ]]; then
                SKIP=true
              fi
              ;;
          esac
          
          echo "skip=$SKIP" >> $GITHUB_OUTPUT

      - name: Install optimum-rbln with tests group dependencies
        if: steps.should_skip.outputs.skip != 'true'
        run: |
          uv sync --frozen --group tests --reinstall-package optimum-rbln

      - name: Install rebel-compiler
        if: steps.should_skip.outputs.skip != 'true'
        run: |
          uv pip install --extra-index-url ${{ secrets.DEV_PKG_URL }} rebel-compiler==${{ inputs.rebel_compiler_version }}

      - name: Prepare artifact paths
        run: |
          ensure_dir() {
            local path="$1"
            if [ -z "$path" ]; then
              return
            fi
            mkdir -p "$path"
          }

          ensure_dir "${{ inputs.save_artifacts_path }}"

      - name: Run tests
        if: steps.should_skip.outputs.skip != 'true'
        env:
          OPTIMUM_RBLN_TEST_LEVEL: ${{ inputs.test_level }}
        run: |
          EXTRA_PYTEST_ARGS=""
          if [ "${{ inputs.save_artifacts_path }}" != "" ]; then
            export SAVE_ARTIFACTS_PATH="${{ inputs.save_artifacts_path }}"
            EXTRA_PYTEST_ARGS="-k test_save_artifacts"
          fi
          if [ "${{ inputs.reuse_artifacts_path }}" != "" ]; then
            export REUSE_ARTIFACTS_PATH="${{ inputs.reuse_artifacts_path }}"
            EXTRA_PYTEST_ARGS="-k test_generate"
          fi

          case "${{ matrix.test_type }}" in
            "config")
              uv run --no-sync pytest -n 1 tests/test_config.py -vv --durations 0
              ;;
            "transformers")
              uv run --no-sync pytest -n 1 tests/test_transformers.py -vv --durations 0 $EXTRA_PYTEST_ARGS
              ;;
            "diffusers")
              uv run --no-sync pytest -n 1 tests/test_diffusers.py -vv --durations 0 $EXTRA_PYTEST_ARGS
              ;;
            "llm")
              SPLITS="${{ matrix.splits || '' }}"
              GROUP="${{ matrix.group || '' }}"
              if [ -n "$SPLITS" ] && [ -n "$GROUP" ]; then
                uv run --no-sync pytest -n 1 tests/test_llm.py --splits "$SPLITS" --group "$GROUP" -vv --durations 0 $EXTRA_PYTEST_ARGS
              else
                uv run --no-sync pytest -n 1 tests/test_llm.py -vv --durations 0 $EXTRA_PYTEST_ARGS
              fi
              ;;
            cli-*)
              # Extract test type from matrix
              case "${{ matrix.test_type }}" in
                "cli-basic")
                  CLI_TEST_TYPE="basic"
                  ;;
                "cli-argument-parsing")
                  CLI_TEST_TYPE="argument-parsing"
                  ;;
                "cli-error-handling")
                  CLI_TEST_TYPE="error-handling"
                  ;;
              esac
              echo "Running CLI test: $CLI_TEST_TYPE"
              uv run --no-sync .github/scripts/test_cli.py "$CLI_TEST_TYPE"
              ;;
          esac

      - name: Skip message
        if: steps.should_skip.outputs.skip == 'true'
        run: |
          echo "Found [skip-${{ matrix.test_type }}] in commit message, skipping CI"
